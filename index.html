<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PotAlert Route Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI', Roboto, sans-serif; }
  #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1; }

  .collapsed-search-bar { position:absolute; top:20px; left:50%; transform:translateX(-50%);
    background:white; padding:12px 16px; border-radius:30px; box-shadow:0 2px 8px rgba(0,0,0,0.15); font-size:16px; color:#666;
    cursor:pointer; z-index:10; }

  .input-panel { position:absolute; top:20px; left:50%; transform:translateX(-50%);
    background:white; padding:16px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); width:90%; max-width:500px;
    z-index:10; display:none; flex-direction: column; gap:10px; }
  .input-panel input, .input-panel select, .input-panel button {
    padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; width:100%;
  }
  .input-panel button { background-color:#4c8bf5; color:white; border:none; font-weight:bold; cursor:pointer; }

  .edit-button { position:absolute; top:90px; right:20px; background:white; border-radius:50%;
    box-shadow:0 2px 10px rgba(0,0,0,0.2); padding:10px; z-index:11; cursor:pointer; font-size:18px; display:none; }
  .edit-button.visible { display:block; }

  .summary-drawer { position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
    background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
    min-width:250px; max-width:95%; padding:12px 20px; z-index:10; cursor:pointer; display:none; }
  .summary-drawer .handle { width:30px; height:4px; background:#ccc; border-radius:2px; margin:0 auto 8px; }
  .summary-content { text-align:center; padding-bottom:4px; }
  .route-row { font-size:16px; font-weight:600; color:#333; display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:10px; }
  .divider { color:#aaa; }
  .address-row { font-size:14px; color:#555; line-height:1.4; text-align:left; margin-top:5px; }
  .address-row span { display:block; font-weight:500; }

  .flag-btn-container { position:absolute; bottom:100px; right:20px; z-index:10; }
  .flag-btn { background:#ffcc00; border:none; padding:12px 16px; border-radius:30px;
              box-shadow:0 3px 10px rgba(0,0,0,0.3); font-weight:bold; font-size:14px; cursor:pointer; }
  #flagMenu { display:none; background:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.3); padding:10px; margin-top:5px; }
  #flagMenu button { margin:5px; padding:8px; cursor:pointer; }
  textarea { width:180px; }
</style>
</head>
<body>

<div class="collapsed-search-bar" id="collapsedSearch" onclick="expandSearch()">üîç Search your route</div>
<div class="input-panel" id="inputPanel">
  <input id="origin" type="text" placeholder="Enter starting point" />
  <input id="destination" type="text" placeholder="Enter destination" />
  <select id="mode">
    <option value="DRIVING">Driving</option>
  </select>
  <button onclick="route()">Get Route</button>
</div>

<div class="edit-button" id="editBtn" title="Edit Route" onclick="showInputPanel()">‚úèÔ∏è</div>

<div class="flag-btn-container">
  <button class="flag-btn" onclick="toggleFlagMenu()">üöß Flag Pothole</button>
  <div id="flagMenu">
    <button onclick="flagCurrentLocation()">üìç Current Location</button>
    <button onclick="flagOtherLocation()">üñ±Ô∏è Other Location</button>
  </div>
</div>

<div class="summary-drawer" id="summaryDrawer">
  <div class="handle"></div>
  <div class="summary-content" id="summaryContent">
    <div class="route-row">
      <span>üöó <span id="distanceText">--</span></span>
      <span class="divider">|</span>
      <span>‚è±Ô∏è <span id="durationText">--</span></span>
    </div>
    <div class="address-row">
      <span><strong>From:</strong> <span id="startAddress">--</span></span>
      <span><strong>To:</strong> <span id="endAddress">--</span></span>
    </div>
  </div>
</div>

<div id="map"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDDuhOl5PKn8m4OA_4kyBMSeuHp1p39ROU",
    authDomain: "potalert-f86b6.firebaseapp.com",
    projectId: "potalert-f86b6",
    storageBucket: "potalert-f86b6.firebasestorage.app",
    messagingSenderId: "986396351519",
    appId: "1:986396351519:web:182f21a8b73f92cc95c92a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let map, directionsService, directionsRenderer, userMarker;
  let flaggingPothole = false;
  let potholes = [];

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), { center:{lat:0,lng:0}, zoom:13 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });

    const originInput = document.getElementById("origin");
    const destinationInput = document.getElementById("destination");
    const originAutocomplete = new google.maps.places.Autocomplete(originInput);
    const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);
    originAutocomplete.setFields(["formatted_address"]);
    destinationAutocomplete.setFields(["formatted_address"]);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(loc);
        userMarker = new google.maps.Marker({
          position: loc,
          map: map,
          title: "Your Location",
          icon:{ path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:"#4285F4", fillOpacity:1, strokeWeight:2, strokeColor:"#fff" }
        });
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({location:loc}, (results,status)=>{
          if(status==="OK" && results[0]) originInput.value = results[0].formatted_address;
        });
      }, ()=>alert("Location access denied."));
    }

    map.addListener("click", (e) => {
      if(flaggingPothole){
        addPotholeMarker(e.latLng);
        flaggingPothole=false;
      }
    });

    // Load existing potholes from Firestore
    db.collection("potholes").get().then(querySnapshot => {
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const latLng = new google.maps.LatLng(data.latitude, data.longitude);
        addPotholeMarker(latLng, data.description || "üöß Pothole reported", doc.id);
      });
    });
  }

  function expandSearch(){ 
    document.getElementById("collapsedSearch").style.display="none"; 
    document.getElementById("inputPanel").style.display="flex"; 
  }

  function route(){
    const origin = document.getElementById("origin").value;
    const destination = document.getElementById("destination").value;
    const travelMode = document.getElementById("mode").value;
    if(!origin || !destination) return;

    directionsService.route({ 
      origin, destination, 
      travelMode: google.maps.TravelMode[travelMode] 
    }, (result,status)=>{
      if(status==="OK"){
        directionsRenderer.setDirections(result);
        const bounds = new google.maps.LatLngBounds();
        result.routes[0].overview_path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);

        const leg=result.routes[0].legs[0];
        document.getElementById("distanceText").innerText=leg.distance.text;
        document.getElementById("durationText").innerText=leg.duration.text;
        document.getElementById("startAddress").innerText=leg.start_address;
        document.getElementById("endAddress").innerText=leg.end_address;
        document.getElementById("summaryDrawer").style.display="block";
        document.getElementById("inputPanel").style.display="none";
        document.getElementById("editBtn").classList.add("visible");
      } else alert("Route failed: "+status);
    });
  }

  function showInputPanel(){ 
    document.getElementById("inputPanel").style.display="flex"; 
    document.getElementById("editBtn").classList.remove("visible"); 
    document.getElementById("summaryDrawer").style.display="none"; 
  }

  function toggleFlagMenu(){
    const menu=document.getElementById("flagMenu");
    menu.style.display = menu.style.display==="none"?"block":"none";
  }

  function flagCurrentLocation(){
    if(userMarker){ 
      addPotholeMarker(userMarker.getPosition()); 
      alert("Pothole flagged at current location!"); 
    } else alert("Current location not available.");
    document.getElementById("flagMenu").style.display="none";
  }

  function flagOtherLocation(){
    alert("Click on the map to flag a pothole at a different location.");
    flaggingPothole=true;
    document.getElementById("flagMenu").style.display="none";
  }

  function addPotholeMarker(position, description="üöß Pothole reported", docId=null) {
    const index = potholes.length;
    const marker = new google.maps.Marker({
      position, map, draggable:true, icon:"https://maps.google.com/mapfiles/ms/icons/orange-dot.png"
    });

    const content = `
      <div>
        <textarea id="desc-${index}" rows="2">${description}</textarea><br>
        <button onclick="savePothole(${index})">Save</button>
        <button onclick="deletePothole(${index})" style="background:red; color:white;">Delete</button>
      </div>`;
    const info = new google.maps.InfoWindow({ content });
    marker.addListener("click", () => info.open(map, marker));
    potholes.push({ marker, description, info, docId });
    info.open(map, marker);

    if(!docId){
      db.collection("potholes").add({
        latitude: position.lat(),
        longitude: position.lng(),
        description: description,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(docRef=> potholes[index].docId = docRef.id)
        .catch(err=>console.error("Error saving pothole:", err));
    }
  }

  function savePothole(index){
    const textarea=document.getElementById(`desc-${index}`);
    if(textarea){
      potholes[index].description = textarea.value;
      potholes[index].info.setContent(`<strong>${textarea.value}</strong><br>
        <button onclick="deletePothole(${index})" style="background:red;color:white;">Delete</button>`);

      if(potholes[index].docId){
        db.collection("potholes").doc(potholes[index].docId).update({ description: textarea.value })
          .then(()=>console.log("Pothole updated in Firestore"))
          .catch(err=>console.error("Error updating:", err));
      }
      alert("Pothole updated!");
    }
  }

  function deletePothole(index){
    const p = potholes[index];
    if(p){
      p.marker.setMap(null);
      p.info.close();
      if(p.docId){
        db.collection("potholes").doc(p.docId).delete()
          .then(()=>console.log("Pothole deleted from Firestore"))
          .catch(err=>console.error("Error deleting:", err));
      }
      potholes.splice(index,1);
      alert("Pothole deleted!");
    }
  }
</script>

<!-- Google Maps API (replace YOUR_API_KEY) -->
<script async
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCx1OCaxrUgjkHTbWT8I_SItDawpU5xaV4&libraries=places&callback=initMap">
</script>

</body>
</html>
