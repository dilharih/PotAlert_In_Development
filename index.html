<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PotAlert Route Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI', Roboto, sans-serif; }
  #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1; }

  .collapsed-search-bar { position:absolute; top:20px; left:50%; transform:translateX(-50%);
    background:white; padding:12px 16px; border-radius:30px; box-shadow:0 2px 8px rgba(0,0,0,0.15); font-size:16px; color:#666;
    cursor:pointer; z-index:10; }

  .input-panel { position:absolute; top:20px; left:50%; transform:translateX(-50%);
    background:white; padding:16px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); width:90%; max-width:500px;
    z-index:10; display:none; flex-direction: column; gap:10px; }
  .input-panel input, .input-panel select, .input-panel button {
    padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; width:100%;
  }
  .input-panel button { background-color:#4c8bf5; color:white; border:none; font-weight:bold; cursor:pointer; }

  .edit-button { position:absolute; top:90px; right:20px; background:white; border-radius:50%;
    box-shadow:0 2px 10px rgba(0,0,0,0.2); padding:10px; z-index:11; cursor:pointer; font-size:18px; display:none; }
  .edit-button.visible { display:block; }

  .summary-drawer { position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
    background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
    min-width:250px; max-width:95%; padding:12px 20px; z-index:10; cursor:pointer; display:none; }
  .summary-drawer .handle { width:30px; height:4px; background:#ccc; border-radius:2px; margin:0 auto 8px; }
  .summary-content { text-align:center; padding-bottom:4px; }
  .route-row { font-size:16px; font-weight:600; color:#333; display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:10px; }
  .divider { color:#aaa; }
  .address-row { font-size:14px; color:#555; line-height:1.4; text-align:left; margin-top:5px; }
  .address-row span { display:block; font-weight:500; }

  .flag-btn-container { position:absolute; bottom:100px; right:20px; z-index:10; }
  .flag-btn { background:#ffcc00; border:none; padding:12px 16px; border-radius:30px;
              box-shadow:0 3px 10px rgba(0,0,0,0.3); font-weight:bold; font-size:14px; cursor:pointer; }
  #flagMenu { display:none; background:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.3); padding:10px; margin-top:5px; }
  #flagMenu button { margin:5px; padding:8px; cursor:pointer; }

  /* Toast Notification */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(50, 50, 50, 0.95);
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 15px;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.4s ease, top 0.4s ease;
  }
  .toast.show {
    opacity: 1;
    top: 40px;
  }
</style>
</head>
<body>

<div class="collapsed-search-bar" id="collapsedSearch" onclick="expandSearch()">üîç Search your route</div>
<div class="input-panel" id="inputPanel">
  <input id="origin" type="text" placeholder="Enter starting point" />
  <input id="destination" type="text" placeholder="Enter destination" />
  <select id="mode">
    <option value="DRIVING">Driving</option>
  </select>
  <button onclick="route()">Get Route</button>
</div>

<div class="edit-button" id="editBtn" title="Edit Route" onclick="showInputPanel()">‚úèÔ∏è</div>

<div class="flag-btn-container">
  <button class="flag-btn" onclick="toggleFlagMenu()">üöß Flag Pothole</button>
  <div id="flagMenu">
    <button onclick="flagCurrentLocation()">üìç Current Location</button>
    <button onclick="flagOtherLocation()">üñ±Ô∏è Other Location</button>
  </div>
</div>

<div class="summary-drawer" id="summaryDrawer">
  <div class="handle"></div>
  <div class="summary-content" id="summaryContent">
    <div class="route-row">
      <span>üöó <span id="distanceText">--</span></span>
      <span class="divider">|</span>
      <span>‚è±Ô∏è <span id="durationText">--</span></span>
      <span class="divider">|</span>
      <span>üöß <span id="potholeCount">--</span> potholes</span>
    </div>
    <div class="address-row">
      <span><strong>From:</strong> <span id="startAddress">--</span></span>
      <span><strong>To:</strong> <span id="endAddress">--</span></span>
    </div>
  </div>
</div>

<div id="map"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDDuhOl5PKn8m4OA_4kyBMSeuHp1p39ROU",
  authDomain: "potalert-f86b6.firebaseapp.com",
  projectId: "potalert-f86b6",
  storageBucket: "potalert-f86b6.firebasestorage.app",
  messagingSenderId: "986396351519",
  appId: "1:986396351519:web:182f21a8b73f92cc95c92a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let map, directionsService, userMarker;
let flaggingPothole = false;
let potholes = [];
let routePolylines = [];
let selectedRouteIndex = null;

const darkMapStyle = [
  { elementType: 'geometry', stylers: [{color: '#242f3e'}] },
  { elementType: 'labels.text.stroke', stylers: [{color:'#242f3e'}] },
  { elementType: 'labels.text.fill', stylers: [{color:'#746855'}] },
  { featureType:'road', elementType:'geometry', stylers:[{color:'#38414e'}] },
  { featureType:'road', elementType:'geometry.stroke', stylers:[{color:'#212a37'}] },
  { featureType:'water', elementType:'geometry', stylers:[{color:'#17263c'}] }
];

function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:0,lng:0}, zoom:13, styles: darkMapStyle
  });
  directionsService = new google.maps.DirectionsService();

  const originInput = document.getElementById("origin");
  const destinationInput = document.getElementById("destination");
  new google.maps.places.Autocomplete(originInput);
  new google.maps.places.Autocomplete(destinationInput);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const loc={lat:pos.coords.latitude, lng:pos.coords.longitude};
      map.setCenter(loc);
      userMarker=new google.maps.Marker({
        position:loc, map:map, title:"Your Location",
        icon:{path:google.maps.SymbolPath.CIRCLE, scale:8, fillColor:"#4285F4", fillOpacity:1, strokeWeight:2, strokeColor:"#fff"}
      });
      new google.maps.Geocoder().geocode({location:loc},(results,status)=>{
        if(status==="OK"&&results[0]) originInput.value=results[0].formatted_address;
      });
    },()=>showToast("‚ö†Ô∏è Location access denied."));
  }

  map.addListener("click",e=>{
    if(flaggingPothole){ addPotholeMarker(e.latLng); flaggingPothole=false; }
  });

  // Real-time potholes
  db.collection("potholes").onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(change=>{
      const data=change.doc.data();
      const latLng=new google.maps.LatLng(data.latitude,data.longitude);
      if(change.type==="added") addPotholeMarker(latLng,data.description||"üöß Pothole",change.doc.id,false);
      if(change.type==="removed"){
        const i=potholes.findIndex(p=>p.docId===change.doc.id);
        if(i!==-1){ potholes[i].marker.setMap(null); potholes.splice(i,1); }
      }
    });
  });
}

function expandSearch(){
  document.getElementById("collapsedSearch").style.display="none";
  document.getElementById("inputPanel").style.display="flex";
}

function route(){
  const origin=document.getElementById("origin").value;
  const destination=document.getElementById("destination").value;
  if(!origin||!destination) return;

  directionsService.route({
    origin,destination,travelMode:'DRIVING',provideRouteAlternatives:true
  },(result,status)=>{
    if(status==="OK"){
      clearRoutePolylines();
      const potholeCounts = [];
      routePolylines = result.routes.map((r,i)=>{
        const poly=new google.maps.Polyline({
          path:r.overview_path, strokeColor:'#4c8bf5', strokeOpacity:0.5, strokeWeight:5, map
        });
        const count=countPotholesOnRoute(r);
        potholeCounts.push(count);
        poly.addListener("click",()=>selectRoute(i,r));
        return poly;
      });

      // highlight best route (min potholes)
      const minIndex=potholeCounts.indexOf(Math.min(...potholeCounts));
      routePolylines[minIndex].setOptions({strokeColor:'#00FF00', strokeWeight:6, strokeOpacity:0.9});

      const bounds=new google.maps.LatLngBounds();
      result.routes.forEach(r=>r.overview_path.forEach(p=>bounds.extend(p)));
      map.fitBounds(bounds);
      showToast("Select a route to view potholes and details.");
    } else showToast("‚ö†Ô∏è Route failed: "+status);
  });
}

function selectRoute(index,route){
  selectedRouteIndex=index;
  routePolylines.forEach((p,i)=>p.setOptions({strokeOpacity:i===index?1:0.5,strokeWeight:i===index?8:5}));

  const leg=route.legs[0];
  const potholesOnRoute = highlightPotholesOnRoute(route);
  document.getElementById("distanceText").innerText = leg.distance.text;
  document.getElementById("durationText").innerText = leg.duration.text;
  document.getElementById("startAddress").innerText = leg.start_address;
  document.getElementById("endAddress").innerText = leg.end_address;
  document.getElementById("potholeCount").innerText = potholesOnRoute;
  document.getElementById("summaryDrawer").style.display="block";
  document.getElementById("inputPanel").style.display="none";
  document.getElementById("editBtn").classList.add("visible");
}

// Highlight potholes visually & count them
function highlightPotholesOnRoute(route){
  const toleranceMeters=40;
  let count=0;
  const densified=[];
  const path=route.overview_path;

  for(let i=0;i<path.length-1;i++){
    const start=path[i], end=path[i+1];
    const dist=google.maps.geometry.spherical.computeDistanceBetween(start,end);
    const num=Math.ceil(dist/10);
    for(let j=0;j<=num;j++){
      const lat=start.lat()+(end.lat()-start.lat())*(j/num);
      const lng=start.lng()+(end.lng()-start.lng())*(j/num);
      densified.push(new google.maps.LatLng(lat,lng));
    }
  }

  potholes.forEach(p=>{
    const pos=p.marker.getPosition();
    let near=false;
    for(const dp of densified){
      if(google.maps.geometry.spherical.computeDistanceBetween(pos,dp)<=toleranceMeters){
        near=true; break;
      }
    }
    if(near){
      count++;
      p.marker.setIcon("https://maps.google.com/mapfiles/kml/shapes/caution.png");
      p.marker.setAnimation(google.maps.Animation.BOUNCE);
      setTimeout(()=>p.marker.setAnimation(null),1200);
    } else {
      p.marker.setIcon("https://maps.google.com/mapfiles/kml/shapes/placemark_circle_highlight.png");
    }
  });

  return count;
}

function countPotholesOnRoute(route){
  const toleranceMeters=40;
  let count=0;
  const path=route.overview_path;
  for(const pothole of potholes){
    const pos=pothole.marker.getPosition();
    for(let i=0;i<path.length-1;i++){
      const d=google.maps.geometry.spherical.computeDistanceBetween(pos,path[i]);
      if(d<toleranceMeters){ count++; break; }
    }
  }
  return count;
}

function clearRoutePolylines(){ routePolylines.forEach(p=>p.setMap(null)); routePolylines=[]; }

function showInputPanel(){
  document.getElementById("inputPanel").style.display="flex";
  document.getElementById("editBtn").classList.remove("visible");
  document.getElementById("summaryDrawer").style.display="none";
}

function toggleFlagMenu(){
  const menu=document.getElementById("flagMenu");
  menu.style.display=menu.style.display==="none"?"block":"none";
}

function flagCurrentLocation(){
  if(userMarker){ addPotholeMarker(userMarker.getPosition()); showToast("üöß Pothole flagged at current location!"); }
  else showToast("‚ö†Ô∏è Current location not available.");
  document.getElementById("flagMenu").style.display="none";
}

function flagOtherLocation(){
  showToast("üñ±Ô∏è Click on the map to flag a pothole at a different location.");
  flaggingPothole=true;
  document.getElementById("flagMenu").style.display="none";
}

function addPotholeMarker(position, description = "üöß Pothole reported", docId = null, showInfo = false) {
  const marker = new google.maps.Marker({
    position,
    map,
    draggable: true,
    icon: {
      url: "https://maps.google.com/mapfiles/kml/shapes/caution.png",
      scaledSize: new google.maps.Size(25, 25), // smaller size, similar to current location marker
      anchor: new google.maps.Point(12, 12)
    }
  });

  const index = potholes.length;
  const infoContent = `
    <div>
      <textarea id="desc-${index}" rows="2">${description}</textarea><br>
      <button onclick="savePothole(${index})">Save</button>
      <button onclick="deletePothole(${index})" style="background:red;color:white;">Delete</button>
    </div>
  `;
  const info = new google.maps.InfoWindow({ content: infoContent });
  if (showInfo) info.open(map, marker);
  marker.addListener("click", () => info.open(map, marker));

  potholes.push({ marker, description, info, docId });

  if (!docId) {
    db.collection("potholes")
      .add({
        latitude: position.lat(),
        longitude: position.lng(),
        description: description,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(docRef => (potholes[index].docId = docRef.id))
      .catch(err => console.error("Error saving pothole:", err));
  }
}

  const index=potholes.length;
  const infoContent=`<div><textarea id="desc-${index}" rows="2">${description}</textarea><br>
  <button onclick="savePothole(${index})">Save</button>
  <button onclick="deletePothole(${index})" style="background:red;color:white;">Delete</button></div>`;
  const info=new google.maps.InfoWindow({content:infoContent});
  if(showInfo) info.open(map,marker);
  marker.addListener("click",()=>info.open(map,marker));
  potholes.push({marker,description,info,docId});

  if(!docId){
    db.collection("potholes").add({
      latitude:position.lat(),
      longitude:position.lng(),
      description:description,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    }).then(docRef=>potholes[index].docId=docRef.id)
    .catch(err=>console.error("Error saving pothole:",err));
  }


function savePothole(index){
  const textarea=document.getElementById(`desc-${index}`);
  if(textarea){
    potholes[index].description=textarea.value;
    potholes[index].info.setContent(`<strong>${textarea.value}</strong><br>
      <button onclick="deletePothole(${index})" style="background:red;color:white;">Delete</button>`);
    if(potholes[index].docId){
      db.collection("potholes").doc(potholes[index].docId).update({ description: textarea.value });
    }
    showToast("‚úÖ Pothole updated!");
  }
}

function deletePothole(index){
  const p=potholes[index];
  if(p){
    p.marker.setMap(null); p.info.close();
    if(p.docId){ db.collection("potholes").doc(p.docId).delete(); }
    potholes.splice(index,1);
    showToast("üóëÔ∏è Pothole deleted!");
  }
}

function showToast(msg){
  const toast=document.createElement("div");
  toast.className="toast"; toast.innerText=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add("show"),100);
  setTimeout(()=>{ toast.classList.remove("show"); setTimeout(()=>toast.remove(),400); },3000);
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCx1OCaxrUgjkHTbWT8I_SItDawpU5xaV4&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
